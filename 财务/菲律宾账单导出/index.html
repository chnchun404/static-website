<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>菲律宾站点账单导出</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        primaryLight: '#E8F3FF',
                        primaryDark: '#0E42CC',
                        secondary: '#0E2B8A',
                        light: '#F9FBFF',
                        dark: '#1D2129',
                        gray: '#86909C',
                        grayLight: '#F0F2F5',
                        grayBorder: '#E5E6EB'
                    },
                    fontFamily: {
                        sans: ['Microsoft YaHei', 'PingFang SC', 'sans-serif']
                    },
                    boxShadow: {
                        'card': '0 2px 12px 0 rgba(0, 0, 0, 0.05)',
                        'card-hover': '0 6px 16px 0 rgba(0, 0, 0, 0.08)',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .collapse-item {
                border-bottom: 1px solid theme('colors.grayBorder');
            }
            /* 通用折叠面板展开样式 - 提升优先级确保生效 */
            .collapse-header.active + .collapse-content {
                max-height: 2000px !important;
                opacity: 1 !important;
                padding-top: 1rem !important;
                transition: all 0.4s ease-in-out !important;
            }
            .collapse-content {
                max-height: 0 !important;
                opacity: 0 !important;
                transition: all 0.4s ease-in-out !important;
                overflow: hidden !important;
                padding-top: 0 !important;
            }
            .step-card {
                border-left: 3px solid theme('colors.primaryLight');
                padding-left: 1rem;
                margin-bottom: 1.5rem;
                position: relative;
            }
            .step-card::before {
                content: '';
                position: absolute;
                left: -3px;
                top: 0;
                height: 100%;
                width: 3px;
                background: linear-gradient(to bottom, theme('colors.primary'), transparent);
                opacity: 0.3;
            }
            .table-hover-row {
                transition: background-color 0.2s ease;
            }
            /* 折叠图标旋转动画 - 绑定active类，确保交互反馈 */
            .collapse-header i.fa-chevron-down {
                transition: transform 0.3s ease-in-out !important;
                transform: rotate(0) !important;
            }
            .collapse-header.active i.fa-chevron-down {
                transform: rotate(180deg) !important;
            }
        }
    </style>
</head>
<body class="bg-light text-dark font-sans min-h-screen">
    <!-- 页面头部 -->
    <header class="py-8 px-4 sm:px-6 lg:px-8 bg-gradient-to-b from-white to-primaryLight">
        <div class="max-w-4xl mx-auto text-center">
            <h1 class="text-[clamp(22px,4vw,32px)] font-bold text-secondary mb-3">
                菲律宾站点账单导出-自动化处理流程
            </h1>
            <p class="text-gray text-base sm:text-lg max-w-3xl mx-auto">
                菲律宾多平台店铺订单/账单自动化导出 | 石墨文档店铺信息导出 · 战斧浏览器多店铺批量导出 · 本土/跨境店差异化处理 · Shopee 3PF双账户独立导出 · 标准化文件分类归档
            </p>
        </div>
    </header>

    <main class="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8 space-y-6">
        <!-- 板块1：业务背景 -->
        <section class="bg-white rounded-xl p-6 shadow-card hover:shadow-card-hover transition-shadow duration-300">
            <div class="flex items-center mb-4">
                <div class="w-9 h-9 rounded-full bg-primary/10 flex items-center justify-center mr-3">
                    <i class="fa fa-bullseye text-primary"></i>
                </div>
                <h2 class="text-xl sm:text-2xl font-semibold text-dark">一、业务背景</h2>
            </div>
            <!-- 实施目的 -->
            <div class="pl-12 text-base leading-relaxed text-dark/85 mb-6">
                <h3 class="font-medium text-dark mb-2">1.1 实施目的</h3>
                <p>财务/运营部门需完成<b>菲律宾Lazada/Shopee/TikTok（含本土/跨境店）多平台多店铺</b>的订单、账单自动化导出与标准化归档，核心是从<b>石墨文档</b>导出菲律宾店铺信息底表，通过<b>战斧浏览器</b>批量访问各平台菲律宾店铺后台提取订单/账单原始数据，按平台规则差异化处理（含Shopee 3PF跨境店双账户独立登录、TikTok本土/跨境店不同域名访问、Lazada菲律宾站点专属导出逻辑），自动按「组长-运营-店铺」层级创建标准化存储路径，实现菲律宾多平台订单/账单导出、分类、归档的自动化、标准化，解决人工导出效率低、跨境/本土店规则混淆、双账户操作繁琐、文件存储混乱、重复导出等痛点。</p>
                <p class="mt-2">人工完成菲律宾多平台多店铺订单/账单导出、跨境店双账户切换、本土/跨境规则区分、文件层级分类等工作，存在<b>操作繁琐、效率极低、账户切换易出错、文件存储混乱、跨境/本土店导出路径混淆、重复导出无校验</b>等痛点，通过自动化流程实现多平台订单/账单的一键批量导出、智能差异化处理、标准化路径归档、文件存在性校验，提升菲律宾站点账单处理效率与准确性，同时针对Shopee 3PF跨境店双账户（24个专属店铺）实现独立登录、独立导出、独立归档，解决跨账户权限混淆问题。</p>
            </div>
            <!-- 基本信息 -->
            <div class="pl-12 overflow-x-auto">
                <h3 class="font-medium text-dark mb-2">1.2 基础信息</h3>
                <table class="w-full border-collapse text-sm">
                    <thead>
                        <tr class="bg-primaryLight text-left">
                            <th class="p-3 border border-grayBorder font-medium text-primary">流程名称</th>
                            <th class="p-3 border border-grayBorder font-medium text-primary">所属部门</th>
                            <th class="p-3 border border-grayBorder font-medium text-primary">操作频率</th>
                            <th class="p-3 border border-grayBorder font-medium text-primary">核心目标</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="table-hover-row hover:bg-primaryLight/50">
                            <td class="p-3 border border-grayBorder">战斧_菲律宾店铺_账单与订单导出</td>
                            <td class="p-3 border border-grayBorder">财务部</td>
                            <td class="p-3 border border-grayBorder">月度执行（手动触发）</td>
                            <td class="p-3 border border-grayBorder">自动导出石墨店铺信息、战斧多店铺订单/账单批量导出、Shopee 3PF双账户（24店）独立处理、TikTok本土/跨境差异化访问、标准化路径自动创建、文件存在性校验、异常店铺日志记录</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 板块2：功能模块 -->
        <section class="bg-white rounded-xl p-6 shadow-card hover:shadow-card-hover transition-shadow duration-300">
            <div class="flex items-center mb-4">
                <div class="w-9 h-9 rounded-full bg-primary/10 flex items-center justify-center mr-3">
                    <i class="fa fa-desktop text-primary"></i>
                </div>
                <h2 class="text-xl sm:text-2xl font-semibold text-dark">二、功能模块</h2>
            </div>
            <!-- 应用系统 -->
            <div class="pl-12 mb-6">
                <h3 class="font-medium text-dark mb-2">2.1 涉及应用系统</h3>
                <p class="text-sm text-dark/80 mb-3">系统类型：浏览器网页/客户端/自动化工具/共享存储服务 | 验证码类型：点选验证 | 多账号/多店铺/双账户独立校验（按平台/店铺/账户区分）</p>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse text-sm">
                        <thead>
                            <tr class="bg-primaryLight text-left">
                                <th class="p-3 border border-grayBorder font-medium text-primary">系统名称</th>
                                <th class="p-3 border border-grayBorder font-medium text-primary">类型</th>
                                <th class="p-3 border border-grayBorder font-medium text-primary">需账号密码</th>
                                <th class="p-3 border border-grayBorder font-medium text-primary">核心用途</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="table-hover-row hover:bg-primaryLight/50">
                                <td class="p-3 border border-grayBorder">石墨文档</td>
                                <td class="p-3 border border-grayBorder">浏览器网页</td>
                                <td class="p-3 border border-grayBorder">Yes</td>
                                <td class="p-3 border border-grayBorder">菲律宾店铺信息底表导出、店铺基础信息（平台/类型/运营/组长）数据源提供</td>
                            </tr>
                            <tr class="table-hover-row hover:bg-primaryLight/50">
                                <td class="p-3 border border-grayBorder">战斧浏览器</td>
                                <td class="p-3 border border-grayBorder">客户端/自动化工具</td>
                                <td class="p-3 border border-grayBorder">Yes</td>
                                <td class="p-3 border border-grayBorder">多店铺批量登录、各平台菲律宾后台订单/账单一键导出、Shopee 3PF双账户切换、插件化自动化执行</td>
                            </tr>
                            <tr class="table-hover-row hover:bg-primaryLight/50">
                                <td class="p-3 border border-grayBorder">Lazada/Shopee/TikTok菲律宾后台</td>
                                <td class="p-3 border border-grayBorder">浏览器网页</td>
                                <td class="p-3 border border-grayBorder">Yes（按店铺/账户）</td>
                                <td class="p-3 border border-grayBorder">菲律宾店铺订单/账单数据提取、日期范围筛选、数据导出、跨账户权限验证</td>
                            </tr>
                            <tr class="table-hover-row hover:bg-primaryLight/50">
                                <td class="p-3 border border-grayBorder">Python运行环境</td>
                                <td class="p-3 border border-grayBorder">后台运行</td>
                                <td class="p-3 border border-grayBorder">无</td>
                                <td class="p-3 border border-grayBorder">跨系统逻辑执行、日期计算、路径创建、异常监控、进程管理、日志记录</td>
                            </tr>
                            <tr class="table-hover-row hover:bg-primaryLight/50">
                                <td class="p-3 border border-grayBorder">WPS（Excel/CSV）</td>
                                <td class="p-3 border border-grayBorder">客户端</td>
                                <td class="p-3 border border-grayBorder">无</td>
                                <td class="p-3 border border-grayBorder">导出文件查看、编辑、标准化文件存储</td>
                            </tr>
                            <tr class="table-hover-row hover:bg-primaryLight/50">
                                <td class="p-3 border border-grayBorder">共享存储服务</td>
                                <td class="p-3 border border-grayBorder">网络共享</td>
                                <td class="p-3 border border-grayBorder">Yes</td>
                                <td class="p-3 border border-grayBorder">导出文件存储、标准化路径归档、多用户数据共享、全局变量路径配置</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- 模块概览 -->
            <div class="pl-12 overflow-x-auto mb-6">
                <h3 class="font-medium text-dark mb-2">2.2 核心模块概览</h3>
                <table class="w-full border-collapse text-sm">
                    <thead>
                        <tr class="bg-primaryLight text-left">
                            <th class="p-3 border border-grayBorder font-medium text-primary">模块名称</th>
                            <th class="p-3 border border-grayBorder font-medium text-primary">涉及平台/技术</th>
                            <th class="p-3 border border-grayBorder font-medium text-primary">输出/处理结果</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="table-hover-row hover:bg-primaryLight/50">
                            <td class="p-3 border border-grayBorder">环境清理与路径初始化</td>
                            <td class="p-3 border border-grayBorder">Python+系统命令</td>
                            <td class="p-3 border border-grayBorder">无（环境准备，标准化存储路径/处理完成文件夹创建，进程残留清理）</td>
                        </tr>
                        <tr class="table-hover-row hover:bg-primaryLight/50">
                            <td class="p-3 border border-grayBorder">石墨文档登录与店铺信息导出</td>
                            <td class="p-3 border border-grayBorder">石墨文档+Python+pandas</td>
                            <td class="p-3 border border-grayBorder">XLSX（菲律宾店铺信息底表，含平台/类型/运营/组长）</td>
                        </tr>
                        <tr class="table-hover-row hover:bg-primaryLight/50">
                            <td class="p-3 border border-grayBorder">战斧浏览器登录与多店铺导出</td>
                            <td class="p-3 border border-grayBorder">战斧浏览器+各平台菲律宾后台+Python</td>
                            <td class="p-3 border border-grayBorder">XLSX/CSV（各店铺订单/账单原始数据，按组长-运营分类）</td>
                        </tr>
                        <tr class="table-hover-row hover:bg-primaryLight/50">
                            <td class="p-3 border border-grayBorder">Shopee 3PF双账户独立处理</td>
                            <td class="p-3 border border-grayBorder">Shopee菲律宾跨境后台+Python+战斧浏览器</td>
                            <td class="p-3 border border-grayBorder">XLSX/CSV（3PF 24个店铺订单/账单，按双账户分类归档）</td>
                        </tr>
                        <tr class="table-hover-row hover:bg-primaryLight/50">
                            <td class="p-3 border border-grayBorder">TikTok本土/跨境差异化导出</td>
                            <td class="p-3 border border-grayBorder">TikTok菲律宾后台+Python+战斧浏览器</td>
                            <td class="p-3 border border-grayBorder">XLSX（TikTok店铺订单/账单，按本土/跨境分类归档）</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- 核心能力 -->
            <div class="pl-12">
                <h3 class="font-medium text-dark mb-2">2.3 核心自动化能力</h3>
                <ul class="list-disc pl-6 text-sm space-y-2 text-dark/85">
                    <li>流程启动前自动清理环境，强制终止战斧浏览器/WPS残留进程（taskkill），关闭所有Chrome窗口，避免进程占用导致文件/页面操作失败</li>
                    <li>按「菲律宾+年月+组长组+运营+店铺」自动创建标准化存储路径，所有导出文件按层级分类归档，解决文件存储混乱问题，方便后续查询与统计</li>
                    <li>石墨文档自动登录+点选验证码自动处理，一键导出菲律宾店铺信息底表，自动补全空值（组长/运营名称向下填充），生成标准化店铺信息数据源</li>
                    <li>战斧浏览器自动化登录与店铺管理，支持菲律宾Lazada/Shopee/TikTok多店铺批量打开、订单/账单一键导出，按平台规则生成对应格式文件（Lazada-XLSX、Shopee-CSV、TikTok-XLSX）</li>
                    <li>店铺信息灵活筛选，支持按「组长+平台/店铺名」精准筛选导出店铺，未匹配到有效店铺则直接抛出异常，避免无效执行</li>
                    <li>Shopee 3PF跨境店双账户智能识别与分离处理，account1/account2独立登录、独立导出、独立归档，自动区分12+12个专属店铺，避免账户权限混淆</li>
                    <li>TikTok本土/跨境店智能识别与差异化访问，本土店自动访问seller-ph.tiktok.com、跨境店自动访问seller.tiktokshopglobalselling.com，适配不同域名导出规则</li>
                    <li>订单/账单导出日期范围自动计算，Lazada/Shopee按自然月筛选、TikTok按UTC时间戳筛选，无需人工配置日期，确保统计数据为整月数据</li>
                    <li>文件存在性校验，若店铺已存在当月订单/账单文件则直接跳过，避免重复导出与存储，提升执行效率</li>
                    <li>账户验证弹窗自动处理，Shopee/TikTok导出过程中触发的账户密码验证弹窗，自动填充密码并完成验证，无需人工干预</li>
                    <li>广告弹窗自动关闭，各平台菲律宾后台导出过程中出现的推广/调研广告弹窗，自动识别并关闭，避免遮挡操作元素导致导出失败</li>
                    <li>全流程异常容错，单个店铺/账户导出失败则捕获异常并记录至error_shop_log全局变量，跳过该店铺继续后续处理，确保流程连续性</li>
                    <li>关键操作重试机制，石墨文档加载、战斧店铺打开、平台页面访问、数据导出等核心操作均支持可配置重试次数（retry_times），提升流程稳定性</li>
                    <li>导出结果统计，流程结束后自动统计成功导出店铺数量，记录失败店铺信息，方便人工兜底处理</li>
                    <li>多格式文件兼容处理，支持XLSX/CSV两种导出格式，与各平台菲律宾后台导出格式保持一致，可直接用WPS/Excel打开编辑</li>
                    <li>战斧插件自动重启，店铺打开失败时自动重启战斧对应店铺插件，重新尝试访问平台后台，提升店铺打开成功率</li>
                    <li>Shopee 3PF账单按「已完成拨款」轮次导出，支持「本轮+指定日期范围所有轮次」批量导出，确保账单数据完整性</li>
                </ul>
            </div>
        </section>

        <!-- 板块3：异常处理机制 -->
        <section class="bg-white rounded-xl p-6 shadow-card hover:shadow-card-hover transition-shadow duration-300">
            <div class="flex items-center mb-4">
                <div class="w-9 h-9 rounded-full bg-primary/10 flex items-center justify-center mr-3">
                    <i class="fa fa-exclamation-triangle text-primary"></i>
                </div>
                <h2 class="text-xl sm:text-2xl font-semibold text-dark">三、异常处理机制</h2>
            </div>
            <div class="pl-12 space-y-3">
                <!-- 全部展开/收起按钮 -->
                <div class="collapse-header flex justify-between items-center py-3 px-4 bg-primaryLight/50 rounded-lg cursor-pointer transition-all duration-300 hover:bg-primaryLight/80" id="allCollapseBtn">
                    <span class="font-medium text-primary">展开/收起所有异常处理规则</span>
                    <i class="fa fa-chevron-down text-xs text-primary"></i>
                </div>

                <!-- 步骤1：环境清理与路径初始化 -->
                <div class="collapse-item py-2">
                    <div class="collapse-header flex justify-between items-center py-2 px-0 cursor-pointer group single-collapse-btn">
                        <span class="font-medium text-dark group-hover:text-primary transition-colors">步骤1：环境清理与文件路径初始化</span>
                        <i class="fa fa-chevron-down text-xs text-gray group-hover:text-primary"></i>
                    </div>
                    <div class="collapse-content pl-2 text-gray">
                        <div class="step-card">
                            <p class="mb-2 font-medium text-dark/80">异常处理规则：</p>
                            <ul class="list-disc pl-6 space-y-1 mb-3 text-sm">
                                <li>执行taskkill终止战斧浏览器/WPS进程、xbot.web.close_all关闭Chrome所有窗口时，捕获所有异常不终止流程，避免进程不存在导致启动失败</li>
                                <li>标准化存储路径（明细/年月/战斧/组长/年月-平台/年月-运营）通过os.makedirs+exist_ok=True实现自动创建与容错，无需提前手动创建</li>
                                <li>自动创建「处理完成」文件夹（Output_Folder同级），用于后续导出文件打包归档，路径不存在则自动创建</li>
                                <li>全局变量核心路径（Output_Folder）未配置则直接抛出异常，避免后续文件操作因路径无效而失败</li>
                                <li>基于当前时间自动生成毫秒级唯一文件夹，避免同批次导出文件覆盖，确保文件存储唯一性</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 步骤2：石墨文档登录与店铺信息导出 -->
                <div class="collapse-item py-2">
                    <div class="collapse-header flex justify-between items-center py-2 px-0 cursor-pointer group single-collapse-btn">
                        <span class="font-medium text-dark group-hover:text-primary transition-colors">步骤2：石墨文档登录与店铺信息导出</span>
                        <i class="fa fa-chevron-down text-xs text-gray group-hover:text-primary"></i>
                    </div>
                    <div class="collapse-content pl-2 text-gray">
                        <div class="step-card">
                            <p class="mb-2 font-medium text-dark/80">异常处理规则：</p>
                            <ul class="list-disc pl-6 space-y-1 mb-3 text-sm">
                                <li>石墨文档打开时最多重试指定次数（retry_times），每次重试包含页面重载，超时则抛出「网络加载超时」明确异常，便于问题定位</li>
                                <li>登录前检测是否已登录，已登录则直接跳过登录流程，避免重复登录导致的验证码触发，提升执行效率</li>
                                <li>登录过程中触发点选验证码时，调用xbot_extensions.activity_jfbym自动化验证工具处理，验证失败自动重试登录，提升登录成功率</li>
                                <li>菲律宾店铺信息表导出时最多重试指定次数，每次重试后关闭可能残留的「另存为」弹窗，避免弹窗遮挡导致导出失败</li>
                                <li>导出后强制校验文件存在性，文件未生成则标记导出失败并继续重试，多次失败则抛出明确异常</li>
                                <li>读取石墨店铺信息表时做数据格式容错，空值按规则填充（组长/运营名称ffill向下填充），避免无效数据参与后续处理</li>
                                <li>店铺信息表处理后按平台/店铺类型分类，自动筛选Shopee 3PF、TikTok本土/跨境店铺，为后续差异化处理做准备</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 步骤3：战斧浏览器登录与多店铺导出 -->
                <div class="collapse-item py-2">
                    <div class="collapse-header flex justify-between items-center py-2 px-0 cursor-pointer group single-collapse-btn">
                        <span class="font-medium text-dark group-hover:text-primary transition-colors">步骤3：战斧浏览器登录与多店铺导出</span>
                        <i class="fa fa-chevron-down text-xs text-gray group-hover:text-primary"></i>
                    </div>
                    <div class="collapse-content pl-2 text-gray">
                        <div class="step-card">
                            <p class="mb-2 font-medium text-dark/80">异常处理规则：</p>
                            <ul class="list-disc pl-6 space-y-1 mb-3 text-sm">
                                <li>战斧浏览器启动后自动检测并关闭「设备到期提醒」弹窗，避免弹窗遮挡后续操作元素，最多重试3次弹窗关闭，确保操作界面干净</li>
                                <li>战斧浏览器登录支持可配置重试次数，账号密码验证失败则抛出明确异常，终止流程并提示检查账号密码</li>
                                <li>店铺搜索时校验搜索结果数量，无结果则标记「战斧浏览器不存在该店铺」并跳过，不终止后续店铺处理</li>
                                <li>店铺打开按钮校验，非「打开店铺」按钮则直接跳过，避免点击错误按钮导致的操作异常</li>
                                <li>战斧插件自动重启机制，店铺打开失败时调用zf_Main.OpenScript重启对应店铺插件，重新尝试访问平台后台，最多重试指定次数</li>
                                <li>各平台店铺订单/账单导出均支持独立重试，单次导出失败则重新执行导出流程，最多重试指定次数</li>
                                <li>导出后强制校验文件存在性与有效性，XLSX/CSV文件未生成则标记导出失败，跳过该店铺并继续后续店铺</li>
                                <li>店铺导出完成后自动关闭店铺窗口，释放系统资源，避免多窗口打开导致的浏览器卡顿</li>
                                <li>所有页面操作后均做元素存在性校验，元素未显示则等待后重试，避免页面加载未完成导致的操作无效</li>
                                <li>页面加载超时处理，平台后台页面加载超过指定时长则触发页面重载，重新尝试访问，确保流程不中断</li>
                                <li>Shopee 3PF店铺筛选校验，非3PF店铺跳过双账户处理流程，避免普通店铺进入跨境账户导出逻辑</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 步骤4：Shopee 3PF双账户异常处理 -->
                <div class="collapse-item py-2">
                    <div class="collapse-header flex justify-between items-center py-2 px-0 cursor-pointer group single-collapse-btn">
                        <span class="font-medium text-dark group-hover:text-primary transition-colors">步骤4：Shopee 3PF双账户异常处理</span>
                        <i class="fa fa-chevron-down text-xs text-gray group-hover:text-primary"></i>
                    </div>
                    <div class="collapse-content pl-2 text-gray">
                        <div class="step-card">
                            <p class="mb-2 font-medium text-dark/80">异常处理规则：</p>
                            <ul class="list-disc pl-6 space-y-1 mb-3 text-sm">
                                <li>账户切换前强制执行登出操作，确保前一账户完全退出，避免账户权限混淆导致的导出错误</li>
                                <li>双账户登录均支持可配置重试次数，账号密码验证失败则标记该账户所有店铺导出失败，跳过并继续另一账户处理</li>
                                <li>3PF店铺与账户自动匹配，非对应账户店铺无法导出则标记失败，避免跨账户操作导致的权限异常</li>
                                <li>账户验证弹窗自动处理，导出过程中触发的密码验证弹窗，自动填充对应账户密码并完成验证，最多重试5次</li>
                                <li>轮次导出超时处理，3PF账单按轮次导出时超过指定时长则跳过该轮次，记录日志并继续下一轮次，确保整体流程不中断</li>
                                <li>3PF店铺导出失败则单独记录至error_shop_log，与普通店铺区分，方便人工针对性处理</li>
                                <li>3PF店铺URL访问失败时，自动触发页面重载并重新尝试访问，最多重试指定次数，避免网络波动导致的访问失败</li>
                                <li>双账户导出完成后，强制校验文件数量与完整性，账单缺失轮次文件则标记为导出异常</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 步骤5：各平台导出异常处理 -->
                <div class="collapse-item py-2">
                    <div class="collapse-header flex justify-between items-center py-2 px-0 cursor-pointer group single-collapse-btn">
                        <span class="font-medium text-dark group-hover:text-primary transition-colors">步骤5：Lazada/Shopee/TikTok导出异常处理</span>
                        <i class="fa fa-chevron-down text-xs text-gray group-hover:text-primary"></i>
                    </div>
                    <div class="collapse-content pl-2 text-gray">
                        <div class="step-card">
                            <p class="mb-2 font-medium text-dark/80">异常处理规则：</p>
                            <ul class="list-disc pl-6 space-y-1 mb-3 text-sm">
                                <li>Lazada导出：语言选择自动切换为简体中文，登录时自动完成密码验证，订单/账单日期范围自动填充，导出按钮点击超时则重试</li>
                                <li>Shopee本土导出：广告弹窗自动识别并关闭，账户验证弹窗自动填充密码，导出记录加载超时则重新触发导出，确保文件生成</li>
                                <li>TikTok导出：本土/跨境域名自动匹配，登录时点选验证码自动处理，页面加载中状态持续检测，超时则重载页面</li>
                                <li>TikTok无权限访问处理，检测到「无权限访问」提示则直接标记导出失败，避免无效重试</li>
                                <li>所有平台导出过程中出现的「离开此网站」弹窗，自动点击「离开」按钮，确保页面操作连续性</li>
                                <li>战斧浏览器「关闭提示」弹窗自动处理，点击确认按钮并等待，避免弹窗遮挡后续操作</li>
                                <li>文件下载超时处理，导出按钮点击后长时间未出现下载按钮则重新触发导出，最多重试指定次数</li>
                                <li>单个文件导出失败不影响同店铺其他文件，订单导出失败则继续账单导出，确保数据最大化获取</li>
                                <li>TikTok UTC时间戳计算异常时，自动重新计算时间范围并重新访问订单页面，避免日期筛选错误</li>
                                <li>Shopee账单按轮次导出时，重复轮次自动跳过，避免生成重复账单文件</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 板块4：数据传输规范 -->
        <section class="bg-white rounded-xl p-6 shadow-card hover:shadow-card-hover transition-shadow duration-300">
            <div class="flex items-center mb-4">
                <div class="w-9 h-9 rounded-full bg-primary/10 flex items-center justify-center mr-3">
                    <i class="fa fa-exchange text-primary"></i>
                </div>
                <h2 class="text-xl sm:text-2xl font-semibold text-dark">四、数据传输规范</h2>
            </div>
            <div class="pl-12 space-y-3">
                <!-- 全部展开/收起按钮 -->
                <div class="collapse-header flex justify-between items-center py-3 px-4 bg-primaryLight/50 rounded-lg cursor-pointer transition-all duration-300 hover:bg-primaryLight/80" id="allCollapseBtn2">
                    <span class="font-medium text-primary">展开/收起所有数据传输规则</span>
                    <i class="fa fa-chevron-down text-xs text-primary"></i>
                </div>

                <!-- 规则1：石墨文档店铺信息导出与处理规范 -->
                <div class="collapse-item py-2">
                    <div class="collapse-header flex justify-between items-center py-2 px-0 cursor-pointer group single-collapse-btn">
                        <span class="font-medium text-dark group-hover:text-primary transition-colors">规则1：石墨文档店铺信息导出与处理规范</span>
                        <i class="fa fa-chevron-down text-xs text-gray group-hover:text-primary"></i>
                    </div>
                    <div class="collapse-content pl-2 text-gray">
                        <div class="step-card">
                            <ol class="list-decimal pl-6 space-y-1 text-sm">
                                <li>固定导出文件：菲律宾店铺信息.xlsx，为唯一店铺信息数据源，包含「运营名称、店铺名、店铺缩写、平台、店铺类型、组长」核心列</li>
                                <li>导出格式固定为XLSX，文件命名规则为「菲律宾店铺信息.xlsx」，确保文件名唯一性与识别性</li>
                                <li>导出路径固定为「{毫秒级文件夹}/石墨文档」，所有石墨文件统一归档，方便后续读取</li>
                                <li>数据处理规则：组长、运营名称列空值采用ffill向下填充，确保数据完整性，为后续路径创建提供依据</li>
                                <li>数据分类规则：按「平台」列筛选Lazada/Shopee/TikTok店铺，按「店铺类型」列筛选Shopee 3PF、TikTok跨境店铺，单独存储为列表</li>
                                <li>店铺筛选规则：支持按「组长+平台/店铺名」全局变量筛选指定店铺，未配置则处理所有店铺，筛选无结果则抛出异常</li>
                                <li>3PF店铺筛选规则：平台为Shopee且店铺类型非空的店铺，归为3PF店铺并单独存储，按双账户分类处理</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- 规则2：战斧浏览器多店铺导出规范 -->
                <div class="collapse-item py-2">
                    <div class="collapse-header flex justify-between items-center py-2 px-0 cursor-pointer group single-collapse-btn">
                        <span class="font-medium text-dark group-hover:text-primary transition-colors">规则2：战斧浏览器多店铺导出规范</span>
                        <i class="fa fa-chevron-down text-xs text-gray group-hover:text-primary"></i>
                    </div>
                    <div class="collapse-content pl-2 text-gray">
                        <div class="step-card">
                            <ol class="list-decimal pl-6 space-y-1 text-sm">
                                <li>根存储路径：{Output_Folder}/{毫秒级文件夹}/战斧，所有平台导出文件统一根路径，按组长分类</li>
                                <li>子存储路径：{根路径}/{组长}/{菲律宾YYYY年MM月份}/{菲律宾YYYY年MM月份-运营}/{平台-店铺-运营}，按「组长-运营-店铺」四级分类，实现文件精细化管理</li>
                                <li>文件命名规则：{平台}_{店铺缩写}_{运营名称}_{文件类型}_表格导出_{毫秒数}.xlsx/csv，包含平台、店铺、运营、类型、时间戳，确保文件唯一性</li>
                                <li>导出格式规则：Lazada/TikTok固定为XLSX，Shopee固定为CSV，与平台菲律宾后台导出格式保持一致</li>
                                <li>导出文件类型：所有店铺均导出「订单」+「账单」两类文件，分别命名并存储在同一店铺文件夹</li>
                                <li>文件存在性规则：若目标路径已存在同名文件，则直接跳过导出，避免重复数据生成与文件覆盖</li>
                                <li>异常处理规则：单个店铺导出失败则加入error_shop_log全局变量（按平台分类），继续后续店铺处理，流程结束后打印失败信息</li>
                                <li>3PF店铺路径规则：在普通路径基础上增加「SP-3PF-店铺缩写」标识，与普通Shopee店铺文件隔离，方便区分</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- 规则3：各平台数据导出与日期规范 -->
                <div class="collapse-item py-2">
                    <div class="collapse-header flex justify-between items-center py-2 px-0 cursor-pointer group single-collapse-btn">
                        <span class="font-medium text-dark group-hover:text-primary transition-colors">规则3：Lazada/Shopee/TikTok导出与日期规范</span>
                        <i class="fa fa-chevron-down text-xs text-gray group-hover:text-primary"></i>
                    </div>
                    <div class="collapse-content pl-2 text-gray">
                        <div class="step-card">
                            <ol class="list-decimal pl-6 space-y-1 text-sm">
                                <li>Lazada菲律宾导出：订单日期范围为「上月1日~上月最后一日」、账单日期范围为「上月1日~指定日期」，自动计算无需人工配置</li>
                                <li>Shopee菲律宾本土导出：订单/账单日期范围均为「上月1日~上月最后一日」，通过日历控件自动选择年/月/日，无需手动输入</li>
                                <li>Shopee 3PF导出：账单按「已完成拨款」轮次导出，包含「本轮」+「指定日期范围内所有轮次」，订单按自然月导出</li>
                                <li>TikTok菲律宾本土导出：访问域名固定为seller-ph.tiktok.com，订单日期范围按UTC时间戳筛选、账单按自然月筛选，自动填充日期控件</li>
                                <li>TikTok菲律宾跨境导出：访问域名固定为seller.tiktokshopglobalselling.com，日期筛选规则与本土店一致，适配中文界面控件</li>
                                <li>日期计算规则：通过tools.py工具类的get_date_range/get_date_range2/get_date_range3/get_utc_time方法自动计算，确保跨月份兼容性</li>
                                <li>导出触发规则：所有平台均通过点击「导出按钮」→选择格式→确认导出→下载文件的流程，自动化模拟人工操作</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- 规则4：Shopee 3PF双账户传输规范 -->
                <div class="collapse-item py-2">
                    <div class="collapse-header flex justify-between items-center py-2 px-0 cursor-pointer group single-collapse-btn">
                        <span class="font-medium text-dark group-hover:text-primary transition-colors">规则4：Shopee 3PF双账户数据传输规范</span>
                        <i class="fa fa-chevron-down text-xs text-gray group-hover:text-primary"></i>
                    </div>
                    <div class="collapse-content pl-2 text-gray">
                        <div class="step-card">
                            <ol class="list-decimal pl-6 space-y-1 text-sm">
                                <li>账户1信息：用户名XNKJ888:TCY666、密码Aa123456.，对应SATC/SAAE等12个专属店铺，独立登录与导出</li>
                                <li>账户2信息：用户名XWL888:TCW777、密码Aa123456.，对应SMCM/SCRE等12个专属店铺，独立登录与导出</li>
                                <li>账户切换规则：先处理账户1所有店铺，完成后强制登出，再登录账户2处理对应店铺，避免账户混淆</li>
                                <li>访问路径规则：每个3PF店铺对应固定URL（含cnsc_shop_id），通过字典映射直接访问，无需手动搜索</li>
                                <li>文件存储规则：与普通店铺一致，按「组长-运营-店铺」四级路径存储，增加SP-3PF标识与普通店铺隔离</li>
                                <li>账单命名规则：在普通命名基础上增加「已完成拨款_轮次/本轮」，区分不同轮次账单，如「Shopee_SATC_运营_账单表格导出_已完成拨款_2025-01-01.xlsx」</li>
                                <li>订单命名规则：与普通Shopee店铺一致，无额外后缀，确保命名规范统一</li>
                                <li>轮次筛选规则：按指定日期范围的时间戳筛选轮次，仅导出范围内的账单数据，避免无效数据导出</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- 规则5：全局变量与日志传输规范 -->
                <div class="collapse-item py-2">
                    <div class="collapse-header flex justify-between items-center py-2 px-0 cursor-pointer group single-collapse-btn">
                        <span class="font-medium text-dark group-hover:text-primary transition-colors">规则5：全局变量与日志传输规范</span>
                        <i class="fa fa-chevron-down text-xs text-gray group-hover:text-primary"></i>
                    </div>
                    <div class="collapse-content pl-2 text-gray">
                        <div class="step-card">
                            <ol class="list-decimal pl-6 space-y-1 text-sm">
                                <li>核心入参全局变量（glv）：retry_times（重试次数，整数）、Output_Folder（输出根路径，绝对路径）、shop_name_list（目标店铺列表，列表）、targetshops_3pf（3PF目标店铺列表，列表）</li>
                                <li>过程变量全局变量（glv）：i_select_idx（店铺选择索引，整数）、i_start_time/i_end_time（日期选择索引，整数）、error_shop_log（失败店铺日志，字典，按平台分类）</li>
                                <li>输出变量：output_shop_count（成功导出店铺数量，整数），流程结束后自动统计，打印至控制台</li>
                                <li>变量类型规范：路径类为绝对路径、次数类为整数、日期类为标准化字符串（YYYY-MM-DD/UTC时间戳）、列表类为字符串数组</li>
                                <li>元素标识全局规范：zf_（战斧浏览器元素前缀）、ty_（通用元素前缀）、sp_3pf_（Shopee 3PF元素前缀），所有元素标识固定，确保定位准确</li>
                                <li>日志记录规范：通过xbot.app.logging记录日志，包含INFO/ERROR/WARNING级别，记录核心操作与异常信息，便于问题排查</li>
                                <li>异常日志规范：失败店铺按平台分类记录至error_shop_log字典（lazada/shopee/tiktok），流程结束后可查看，方便人工兜底</li>
                                <li>全局变量生命周期：贯穿整个流程，流程结束后保留关键变量（如error_shop_log、output_shop_count），方便后续流程调用</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 板块5：系统依赖 -->
        <section class="bg-white rounded-xl p-6 shadow-card hover:shadow-card-hover transition-shadow duration-300">
            <div class="flex items-center mb-4">
                <div class="w-9 h-9 rounded-full bg-primary/10 flex items-center justify-center mr-3">
                    <i class="fa fa-cogs text-primary"></i>
                </div>
                <h2 class="text-xl sm:text-2xl font-semibold text-dark">五、系统依赖</h2>
            </div>
            <div class="pl-12 space-y-4">
                <!-- 环境依赖 -->
                <div class="bg-primaryLight/30 rounded-lg p-4">
                    <h3 class="font-medium text-primary mb-2">5.1 运行环境依赖</h3>
                    <ul class="list-disc pl-6 text-sm space-y-1">
                        <li>操作系统：Windows 10/11 64位（需支持taskkill、os.system系统命令，用于进程清理与路径操作）</li>
                        <li>浏览器：Google Chrome 90.0+（支持石墨文档登录、点选验证码处理、多页面加载）</li>
                        <li>自动化工具：战斧浏览器（最新版，支持店铺管理、插件化自动化、多账号/多账户切换、菲律宾各平台后台访问）</li>
                        <li>办公软件：WPS Office 2021+/Microsoft Excel 2016+（支持XLSX/CSV格式、无锁文件读写）</li>
                        <li>运行时：Python 3.8+（需安装指定第三方库，支持数据处理、自动化操作、文件读写）</li>
                        <li>自动化框架：xbot/xbot_visual（影刀RPA框架，提供网页自动化、图像识别、窗口管理核心能力）</li>
                        <li>存储服务：网络共享存储/本地磁盘（支持多级文件夹创建、XLSX/CSV文件写入、多用户访问，需固定共享路径）</li>
                        <li>网络环境：稳定的网络连接，可正常访问石墨文档、战斧浏览器、菲律宾Lazada/Shopee/TikTok后台，无代理限制</li>
                    </ul>
                </div>
                <!-- Python库依赖 -->
                <div class="bg-primaryLight/30 rounded-lg p-4">
                    <h3 class="font-medium text-primary mb-2">5.2 Python第三方库依赖</h3>
                    <ul class="list-disc pl-6 text-sm space-y-1">
                        <li>自动化操作：xbot、xbot_visual（影刀核心库，网页操作、图像识别、窗口管理、文件下载、进程管理）</li>
                        <li>数据处理：pandas（数据读取、清洗、筛选，支持XLSX格式）、numpy（数值运算、空值填充）</li>
                        <li>Excel操作：openpyxl（XLSX文件读写，支持Excel 2007+格式）</li>
                        <li>CSV操作：csv（内置，CSV文件读写，支持Shopee导出格式）</li>
                        <li>文件操作：os（路径处理、文件夹创建、进程调用）</li>
                        <li>正则处理：re（内置，少量数据匹配处理）</li>
                        <li>时间处理：datetime（内置，日期计算、格式转换）、time（内置，毫秒数获取、延时操作）</li>
                        <li>日志与异常：xbot.app.logging（系统日志记录）、traceback（内置，异常堆栈信息捕获）</li>
                        <li>窗口操作：xbot.win32（内置，窗口激活、键盘指令、鼠标操作、进程终止）</li>
                        <li>验证码处理：xbot_extensions.activity_jfbym（点选验证码自动化处理，支持石墨/TikTok验证码）</li>
                        <li>战斧扩展：xbot_extensions.activity_f31a891f（战斧浏览器店铺管理、插件启动、登录、多店铺操作）</li>
                    </ul>
                </div>
                <!-- 权限依赖 -->
                <div class="bg-primaryLight/30 rounded-lg p-4">
                    <h3 class="font-medium text-primary mb-2">5.3 权限依赖</h3>
                    <ul class="list-disc pl-6 text-sm space-y-1">
                        <li>石墨文档：拥有「菲律宾店铺信息」表格的「查看/导出/下载」权限，可正常访问表格内容，无下载限制</li>
                        <li>战斧浏览器：拥有管理员账号权限，可「登录/管理店铺/打开店铺/启动插件」，支持菲律宾各平台店铺批量操作</li>
                        <li>菲律宾各平台后台：按店铺/账户拥有「登录/访问订单/账单模块/查询数据/导出数据」权限，可查看明细，无操作次数限制</li>
                        <li>Shopee 3PF双账户：拥有两个账户的「登录/登出/订单/账单导出」权限，支持多账号切换，账号无操作时长限制</li>
                        <li>存储服务：输出根路径（glv['Output_Folder']）的「读/写/新建/删除」权限，可创建多级子文件夹并写入/编辑文件</li>
                        <li>系统权限：允许执行taskkill命令（终止残留进程）、允许os.system调用系统命令、允许创建多进程/多线程</li>
                        <li>浏览器权限：允许Chrome/战斧浏览器最大化启动、允许同时打开多个窗口、允许非模拟点击/输入，支持插件化运行</li>
                        <li>文件权限：允许读取/写入/编辑XLSX/CSV格式文件，无文件加密/保护限制，生成的文件可被多用户访问/编辑</li>
                    </ul>
                </div>
                <!-- 配置文件依赖 -->
                <div class="bg-primaryLight/30 rounded-lg p-4">
                    <h3 class="font-medium text-primary mb-2">5.4 配置文件与模块依赖</h3>
                    <ul class="list-disc pl-6 text-sm space-y-1">
                        <li>全局变量：glv（package.variables），核心参数：retry_times、Output_Folder、shop_name_list、targetshops_3pf、error_shop_log</li>
                        <li>自定义工具模块：tools.py（提供get_time/get_date_range/get_utc_time等方法，时间处理、日期转换、UTC时间戳计算）</li>
                        <li>战斧扩展模块：xbot_extensions.activity_f31a891f（zf_Main，战斧浏览器登录、插件启动、店铺管理、多店铺导出）</li>
                        <li>验证码扩展模块：xbot_extensions.activity_jfbym（human_click/cs_space_same_object_captcha，点选验证码自动化处理）</li>
                        <li>自定义业务类：Shimo（石墨文档操作封装，登录、店铺信息导出）、Zhanfu（战斧浏览器+多平台导出核心封装）、CommonUtil（通用工具类，封装点击方法）</li>
                        <li>通用工具类：CommonUtil（静态类，封装带重试的点击方法，提供激活/容错能力，禁止实例化，提升页面操作成功率）</li>
                        <li>元素标识配置：所有页面元素标识（zf_/ty_/sp_3pf_）固定配置，与实际页面元素一一对应，确保定位准确</li>
                        <li>图像资源：点选验证码背景/确认按钮图像、平台加载中图像、弹窗关闭图像，需与实际页面图像一致，确保识别准确性</li>
                        <li>3PF配置常量：dict_shopee_3pf_account1/dict_shopee_3pf_account2（3PF店铺与URL映射字典）、dict_shopee_3pf_login_info（双账户登录信息），固定配置无需修改</li>
                    </ul>
                </div>
            </div>
        </section>
    </main>

    <!-- 折叠面板交互逻辑 - 修复所有点击事件、图标旋转、全部联动问题 -->
    <script>
        // 页面加载完成后初始化所有交互，确保DOM元素已完全加载
        document.addEventListener('DOMContentLoaded', function() {
            // 通用方法：切换单个面板状态（含active类切换、图标旋转）
            const toggleSingleCollapse = (btn) => {
                btn.classList.toggle('active');
                const icon = btn.querySelector('i.fa-chevron-down');
                if (icon) {
                    icon.style.transform = btn.classList.contains('active') ? 'rotate(180deg)' : 'rotate(0)';
                }
            };

            // 通用方法：切换全部面板状态（联动单个面板+自身图标旋转）
            const toggleAllCollapse = (allBtn, sectionSelector) => {
                allBtn.classList.toggle('active');
                const isActive = allBtn.classList.contains('active');
                // 联动当前板块下所有单个折叠面板
                const singleBtns = allBtn.closest(sectionSelector).querySelectorAll('.single-collapse-btn');
                singleBtns.forEach(btn => {
                    if (isActive) {
                        btn.classList.add('active');
                        btn.querySelector('i.fa-chevron-down').style.transform = 'rotate(180deg)';
                    } else {
                        btn.classList.remove('active');
                        btn.querySelector('i.fa-chevron-down').style.transform = 'rotate(0)';
                    }
                });
                // 自身图标旋转同步
                const allIcon = allBtn.querySelector('i.fa-chevron-down');
                allIcon.style.transform = isActive ? 'rotate(180deg)' : 'rotate(0)';
            };

            // 1. 绑定所有单个折叠面板的点击事件
            const allSingleBtns = document.querySelectorAll('.single-collapse-btn');
            allSingleBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    toggleSingleCollapse(this);
                });
            });

            // 2. 绑定异常处理机制板块「全部展开/收起」按钮（联动单个面板）
            const allCollapseBtn = document.getElementById('allCollapseBtn');
            if (allCollapseBtn) {
                allCollapseBtn.addEventListener('click', function() {
                    toggleAllCollapse(this, 'section:nth-child(3)');
                });
            }

            // 3. 绑定数据传输规范板块「全部展开/收起」按钮（联动单个面板）
            const allCollapseBtn2 = document.getElementById('allCollapseBtn2');
            if (allCollapseBtn2) {
                allCollapseBtn2.addEventListener('click', function() {
                    toggleAllCollapse(this, 'section:nth-child(4)');
                });
            }

            // 初始化：确保所有折叠图标初始状态为未旋转，无默认active类
            document.querySelectorAll('.collapse-header i.fa-chevron-down').forEach(icon => {
                icon.style.transform = 'rotate(0)';
            });
            document.querySelectorAll('.collapse-header').forEach(btn => {
                btn.classList.remove('active');
            });
        });
    </script>
</body>
</html>
