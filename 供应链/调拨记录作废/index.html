<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>调拨记录作废</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        primaryLight: '#E8F3FF',
                        primaryDark: '#0E42CC',
                        secondary: '#0E2B8A',
                        light: '#F9FBFF',
                        dark: '#1D2129',
                        gray: '#86909C',
                        grayLight: '#F0F2F5',
                        grayBorder: '#E5E6EB'
                    },
                    fontFamily: {
                        sans: ['Microsoft YaHei', 'PingFang SC', 'sans-serif']
                    },
                    boxShadow: {
                        'card': '0 2px 12px 0 rgba(0, 0, 0, 0.05)',
                        'card-hover': '0 6px 16px 0 rgba(0, 0, 0, 0.08)',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .collapse-item {
                border-bottom: 1px solid theme('colors.grayBorder');
            }
            /* 通用折叠面板展开样式 - 提升优先级确保生效 */
            .collapse-header.active + .collapse-content {
                max-height: 2000px !important;
                opacity: 1 !important;
                padding-top: 1rem !important;
                transition: all 0.4s ease-in-out !important;
            }
            .collapse-content {
                max-height: 0 !important;
                opacity: 0 !important;
                transition: all 0.4s ease-in-out !important;
                overflow: hidden !important;
                padding-top: 0 !important;
            }
            .step-card {
                border-left: 3px solid theme('colors.primaryLight');
                padding-left: 1rem;
                margin-bottom: 1.5rem;
                position: relative;
            }
            .step-card::before {
                content: '';
                position: absolute;
                left: -3px;
                top: 0;
                height: 100%;
                width: 3px;
                background: linear-gradient(to bottom, theme('colors.primary'), transparent);
                opacity: 0.3;
            }
            .table-hover-row {
                transition: background-color 0.2s ease;
            }
            /* 折叠图标旋转动画 - 绑定active类，确保交互反馈 */
            .collapse-header i.fa-chevron-down {
                transition: transform 0.3s ease-in-out !important;
                transform: rotate(0) !important;
            }
            .collapse-header.active i.fa-chevron-down {
                transform: rotate(180deg) !important;
            }
        }
    </style>
</head>
<body class="bg-light text-dark font-sans min-h-screen">
    <!-- 页面头部 -->
    <header class="py-8 px-4 sm:px-6 lg:px-8 bg-gradient-to-b from-white to-primaryLight">
        <div class="max-w-4xl mx-auto text-center">
            <h1 class="text-[clamp(22px,4vw,32px)] font-bold text-secondary mb-3">
                调拨记录作废-自动化处理流程
            </h1>
            <p class="text-gray text-base sm:text-lg max-w-3xl mx-auto">
                跨系统调拨记录批量作废方案 | 海仓国际待作废单号提取 · 马帮ERP批量作废 · 多页数据处理 · 作废结果回执单自动生成 · 跨账号登录校验
            </p>
        </div>
    </header>

    <main class="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8 space-y-6">
        <!-- 板块1：业务背景 -->
        <section class="bg-white rounded-xl p-6 shadow-card hover:shadow-card-hover transition-shadow duration-300">
            <div class="flex items-center mb-4">
                <div class="w-9 h-9 rounded-full bg-primary/10 flex items-center justify-center mr-3">
                    <i class="fa fa-bullseye text-primary"></i>
                </div>
                <h2 class="text-xl sm:text-2xl font-semibold text-dark">一、业务背景</h2>
            </div>
            <!-- 实施目的 -->
            <div class="pl-12 text-base leading-relaxed text-dark/85 mb-6">
                <h3 class="font-medium text-dark mb-2">1.1 实施目的</h3>
                <p>计划/供应链部门需将<b>海仓国际系统（泰国/菲律宾）入库订单中的待作废单号</b>同步至<b>马帮ERP分仓调拨发货模块</b>，完成调拨记录的批量作废操作。核心是从海仓国际按指定日期范围筛选入库订单，提取待作废单号，在马帮ERP筛选「待签收状态」的调拨记录，通过单号模糊匹配实现<b>多页数据批量作废</b>，并生成含<b>作废名单、作废件数、作废状态、失败原因</b>的标准化Excel回执单，实现调拨记录作废的自动化、可追溯化。</p>
                <p class="mt-2">人工完成海仓单号查询、马帮ERP手动筛选、逐页勾选调拨记录、手动作废、结果人工统计等工作，存在<b>效率低、易遗漏、多页数据处理繁琐、作废结果无统一记录、跨系统账号切换易出错</b>等痛点，通过自动化流程实现跨系统单号同步与批量作废，精准记录作废结果，提升调拨记录作废效率与可追溯性。</p>
            </div>
            <!-- 基本信息 -->
            <div class="pl-12 overflow-x-auto">
                <h3 class="font-medium text-dark mb-2">1.2 基础信息</h3>
                <table class="w-full border-collapse text-sm">
                    <thead>
                        <tr class="bg-primaryLight text-left">
                            <th class="p-3 border border-grayBorder font-medium text-primary">流程名称</th>
                            <th class="p-3 border border-grayBorder font-medium text-primary">所属部门</th>
                            <th class="p-3 border border-grayBorder font-medium text-primary">操作频率</th>
                            <th class="p-3 border border-grayBorder font-medium text-primary">核心目标</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="table-hover-row hover:bg-primaryLight/50">
                            <td class="p-3 border border-grayBorder">海仓_马帮ERP_分仓调拨记录作废</td>
                            <td class="p-3 border border-grayBorder">供应链部</td>
                            <td class="p-3 border border-grayBorder">按需执行（手动触发）</td>
                            <td class="p-3 border border-grayBorder">自动提取海仓待作废单号、马帮ERP批量作废调拨记录、生成含作废结果的标准化Excel回执单</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 板块2：功能模块 -->
        <section class="bg-white rounded-xl p-6 shadow-card hover:shadow-card-hover transition-shadow duration-300">
            <div class="flex items-center mb-4">
                <div class="w-9 h-9 rounded-full bg-primary/10 flex items-center justify-center mr-3">
                    <i class="fa fa-desktop text-primary"></i>
                </div>
                <h2 class="text-xl sm:text-2xl font-semibold text-dark">二、功能模块</h2>
            </div>
            <!-- 应用系统 -->
            <div class="pl-12 mb-6">
                <h3 class="font-medium text-dark mb-2">2.1 涉及应用系统</h3>
                <p class="text-sm text-dark/80 mb-3">系统类型：浏览器网页/客户端/共享存储服务 | 验证码类型：无 | 多账号独立校验（按站点区分）</p>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse text-sm">
                        <thead>
                            <tr class="bg-primaryLight text-left">
                                <th class="p-3 border border-grayBorder font-medium text-primary">系统名称</th>
                                <th class="p-3 border border-grayBorder font-medium text-primary">类型</th>
                                <th class="p-3 border border-grayBorder font-medium text-primary">需账号密码</th>
                                <th class="p-3 border border-grayBorder font-medium text-primary">核心用途</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="table-hover-row hover:bg-primaryLight/50">
                                <td class="p-3 border border-grayBorder">海仓国际系统</td>
                                <td class="p-3 border border-grayBorder">浏览器网页</td>
                                <td class="p-3 border border-grayBorder">Yes（按站点）</td>
                                <td class="p-3 border border-grayBorder">待作废单号提取、入库订单筛选、日期范围查询、多页数据爬取</td>
                            </tr>
                            <tr class="table-hover-row hover:bg-primaryLight/50">
                                <td class="p-3 border border-grayBorder">马帮ERP</td>
                                <td class="p-3 border border-grayBorder">浏览器网页</td>
                                <td class="p-3 border border-grayBorder">Yes</td>
                                <td class="p-3 border border-grayBorder">调拨记录筛选、批量作废、多页数据处理、待签收状态过滤</td>
                            </tr>
                            <tr class="table-hover-row hover:bg-primaryLight/50">
                                <td class="p-3 border border-grayBorder">Python运行环境</td>
                                <td class="p-3 border border-grayBorder">后台运行</td>
                                <td class="p-3 border border-grayBorder">无</td>
                                <td class="p-3 border border-grayBorder">跨系统逻辑执行、异常监控、进程管理、数据爬取</td>
                            </tr>
                            <tr class="table-hover-row hover:bg-primaryLight/50">
                                <td class="p-3 border border-grayBorder">WPS（Excel）</td>
                                <td class="p-3 border border-grayBorder">客户端</td>
                                <td class="p-3 border border-grayBorder">无</td>
                                <td class="p-3 border border-grayBorder">作废回执单生成、结果数据写入、标准化文件输出</td>
                            </tr>
                            <tr class="table-hover-row hover:bg-primaryLight/50">
                                <td class="p-3 border border-grayBorder">共享存储服务</td>
                                <td class="p-3 border border-grayBorder">网络共享</td>
                                <td class="p-3 border border-grayBorder">Yes</td>
                                <td class="p-3 border border-grayBorder">回执单文件存储、全局变量路径配置、结果文件归档</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- 模块概览 -->
            <div class="pl-12 overflow-x-auto mb-6">
                <h3 class="font-medium text-dark mb-2">2.2 核心模块概览</h3>
                <table class="w-full border-collapse text-sm">
                    <thead>
                        <tr class="bg-primaryLight text-left">
                            <th class="p-3 border border-grayBorder font-medium text-primary">模块名称</th>
                            <th class="p-3 border border-grayBorder font-medium text-primary">涉及平台</th>
                            <th class="p-3 border border-grayBorder font-medium text-primary">输出文件类型</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="table-hover-row hover:bg-primaryLight/50">
                            <td class="p-3 border border-grayBorder">环境清理与回执路径初始化</td>
                            <td class="p-3 border border-grayBorder">Python+系统命令</td>
                            <td class="p-3 border border-grayBorder">无（环境准备）</td>
                        </tr>
                        <tr class="table-hover-row hover:bg-primaryLight/50">
                            <td class="p-3 border border-grayBorder">海仓国际系统登录与账号校验</td>
                            <td class="p-3 border border-grayBorder">海仓国际+Python+xbot</td>
                            <td class="p-3 border border-grayBorder">无（页面准备）</td>
                        </tr>
                        <tr class="table-hover-row hover:bg-primaryLight/50">
                            <td class="p-3 border border-grayBorder">海仓国际待作废单号提取（多页爬取）</td>
                            <td class="p-3 border border-grayBorder">海仓国际+Python+正则</td>
                            <td class="p-3 border border-grayBorder">无（内存单号列表）</td>
                        </tr>
                        <tr class="table-hover-row hover:bg-primaryLight/50">
                            <td class="p-3 border border-grayBorder">马帮ERP登录与调拨页面准备</td>
                            <td class="p-3 border border-grayBorder">马帮ERP+Python+xbot</td>
                            <td class="p-3 border border-grayBorder">无（页面准备）</td>
                        </tr>
                        <tr class="table-hover-row hover:bg-primaryLight/50">
                            <td class="p-3 border border-grayBorder">马帮ERP调拨记录批量作废（多页处理）</td>
                            <td class="p-3 border border-grayBorder">马帮ERP+xbot+xbot_visual</td>
                            <td class="p-3 border border-grayBorder">无（系统操作）</td>
                        </tr>
                        <tr class="table-hover-row hover:bg-primaryLight/50">
                            <td class="p-3 border border-grayBorder">作废结果回执单生成与存储</td>
                            <td class="p-3 border border-grayBorder">Python+pandas+共享存储</td>
                            <td class="p-3 border border-grayBorder">XLSX（作废结果回执单）</td>
                        </tr>
                        <tr class="table-hover-row hover:bg-primaryLight/50">
                            <td class="p-3 border border-grayBorder">回执单路径全局存储</td>
                            <td class="p-3 border border-grayBorder">Python+全局变量glv</td>
                            <td class="p-3 border border-grayBorder">无（路径参数存储）</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- 核心能力 -->
            <div class="pl-12">
                <h3 class="font-medium text-dark mb-2">2.3 核心自动化能力</h3>
                <ul class="list-disc pl-6 text-sm space-y-2 text-dark/85">
                    <li>流程启动前自动清理环境，强制终止WPS残留进程（taskkill），关闭所有Chrome窗口，避免进程占用导致文件操作与页面操作失败</li>
                    <li>跨系统多账号自动登录校验，海仓国际区分泰国/菲律宾站点加载对应账号，马帮ERP单独校验，账号不一致时自动登出重登，确保登录有效性</li>
                    <li>海仓国际入库订单按全局变量配置的日期范围（input_date_start/input_date_end）精准筛选，自动切换「全部」订单状态，适配业务需求变更</li>
                    <li>海仓国际多页数据自动爬取，按90条/页计算循环次数，通过线程爬取待作废单号，确保大数据量高效提取</li>
                    <li>马帮ERP调拨发货页面自动筛选「待签收」状态+备注搜索，支持多页数据处理（100条/页），自动计算总页数并逐页跳转</li>
                    <li>马帮批量作废智能全选逻辑，针对作废后选中状态残留问题，实现「取消全选+重新全选」双重操作，确保选中所有目标记录</li>
                    <li>批量作废严格控制「恢复原仓库库存」复选框为未勾选状态，避免误操作导致的库存异常，仅执行纯作废操作</li>
                    <li>作废结果实时写入Excel回执单，按单号记录作废件数、作废状态、失败原因，实现操作结果可追溯、可核查</li>
                    <li>页面加载状态图像识别监控（加载中_图像），最多循环300次检测，超时自动抛出异常，确保所有页面操作完成</li>
                    <li>通用点击工具类CommonUtil封装，元素点击前激活窗口，最多重试10次，支持忽略错误模式，确保跨系统页面操作稳定性</li>
                    <li>回执单文件自动创建存储文件夹（处理完成），文件命名含当前时间确保唯一性，路径写入全局变量glv['RETURN_RECEIPT']方便后续归档</li>
                    <li>全流程异常捕获与日志记录，所有错误生成完整堆栈信息，回执单精准记录失败原因，方便问题定位与人工兜底处理</li>
                </ul>
            </div>
        </section>

        <!-- 板块3：异常处理机制 -->
        <section class="bg-white rounded-xl p-6 shadow-card hover:shadow-card-hover transition-shadow duration-300">
            <div class="flex items-center mb-4">
                <div class="w-9 h-9 rounded-full bg-primary/10 flex items-center justify-center mr-3">
                    <i class="fa fa-exclamation-triangle text-primary"></i>
                </div>
                <h2 class="text-xl sm:text-2xl font-semibold text-dark">三、异常处理机制</h2>
            </div>
            <div class="pl-12 space-y-3">
                <!-- 全部展开/收起按钮 - 绑定唯一ID，确保联动 -->
                <div class="collapse-header flex justify-between items-center py-3 px-4 bg-primaryLight/50 rounded-lg cursor-pointer transition-all duration-300 hover:bg-primaryLight/80" id="allCollapseBtn">
                    <span class="font-medium text-primary">展开/收起所有异常处理规则</span>
                    <i class="fa fa-chevron-down text-xs text-primary"></i>
                </div>

                <!-- 步骤1：环境清理与回执初始化 -->
                <div class="collapse-item py-2">
                    <div class="collapse-header flex justify-between items-center py-2 px-0 cursor-pointer group single-collapse-btn">
                        <span class="font-medium text-dark group-hover:text-primary transition-colors">步骤1：环境清理与回执单路径初始化</span>
                        <i class="fa fa-chevron-down text-xs text-gray group-hover:text-primary"></i>
                    </div>
                    <div class="collapse-content pl-2 text-gray">
                        <div class="step-card">
                            <p class="mb-2 font-medium text-dark/80">异常处理规则：</p>
                            <ul class="list-disc pl-6 space-y-1 mb-3 text-sm">
                                <li>执行taskkill终止WPS进程、xbot.web.close_all关闭Chrome所有窗口时，捕获所有异常不终止流程，避免进程不存在导致启动失败</li>
                                <li>回执单存储文件夹通过os.makedirs+exist_ok=True实现自动创建与容错，无需提前手动创建，适配重复执行场景</li>
                                <li>回执单DataFrame初始化时强制指定列名和字符串类型（dtype=str），避免后续数据写入时类型不匹配错误</li>
                                <li>回执单文件名通过当前时间戳生成，确保文件唯一性，避免重复执行时文件覆盖</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 步骤2：海仓国际登录与单号提取 -->
                <div class="collapse-item py-2">
                    <div class="collapse-header flex justify-between items-center py-2 px-0 cursor-pointer group single-collapse-btn">
                        <span class="font-medium text-dark group-hover:text-primary transition-colors">步骤2：海仓国际系统登录与待作废单号提取</span>
                        <i class="fa fa-chevron-down text-xs text-gray group-hover:text-primary"></i>
                    </div>
                    <div class="collapse-content pl-2 text-gray">
                        <div class="step-card">
                            <p class="mb-2 font-medium text-dark/80">异常处理规则：</p>
                            <ul class="list-disc pl-6 space-y-1 mb-3 text-sm">
                                <li>海仓国际登录前先校验当前登录用户与目标用户是否一致，同时校验站点类型（泰国1030/菲律宾4980），双重校验确保登录准确性</li>
                                <li>页面打开时最多重试指定次数（retry_times），每次重试包含页面重载，超时则抛出「网络加载超时」明确异常</li>
                                <li>检测到「登陆已失效」弹窗时自动点击确定按钮，重新执行登录流程，避免弹窗遮挡导致登录失败</li>
                                <li>登录后自动关闭「待支付账单」弹窗，避免弹窗遮挡后续操作元素，导致元素定位失败</li>
                                <li>日期范围输入后执行搜索，循环45次检测加载状态，超时则抛出「搜索结果加载超时」异常</li>
                                <li>搜索结果无数据时直接抛出异常终止流程，避免后续空单号列表导致的无效操作</li>
                                <li>通过正则表达式提取数据件数时，强制转换为整数类型，若提取失败则触发异常，确保循环次数计算准确</li>
                                <li>多页爬取后若无有效单号（remark_list为空），直接抛出异常，提示开发者检查爬取逻辑</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 步骤3：马帮ERP登录与页面准备 -->
                <div class="collapse-item py-2">
                    <div class="collapse-header flex justify-between items-center py-2 px-0 cursor-pointer group single-collapse-btn">
                        <span class="font-medium text-dark group-hover:text-primary transition-colors">步骤3：马帮ERP系统登录与调拨页面准备</span>
                        <i class="fa fa-chevron-down text-xs text-gray group-hover:text-primary"></i>
                    </div>
                    <div class="collapse-content pl-2 text-gray">
                        <div class="step-card">
                            <p class="mb-2 font-medium text-dark/80">异常处理规则：</p>
                            <ul class="list-disc pl-6 space-y-1 mb-3 text-sm">
                                <li>马帮ERP登录前先校验当前用户名与目标用户名是否一致，不一致时自动悬停退出并重新登录，确保登录有效性</li>
                                <li>页面打开与登录操作均支持重试机制（retry_times），单次失败不终止流程，提升登录成功率</li>
                                <li>登录成功后自动执行mb_close_box关闭所有弹窗，避免弹窗遮挡调拨模块入口，导致后续操作失败</li>
                                <li>调拨发货页面加载超时设置为300s，适配大数量调拨记录数据加载，确保页面完全渲染</li>
                                <li>所有页面操作后均执行is_exists_loading加载监控，最多循环300次检测加载图标，超时则抛出「加载失败」异常</li>
                                <li>页面操作前通过CommonUtil.click激活窗口，避免浏览器窗口后台导致点击操作无效</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 步骤4：马帮调拨记录批量作废 -->
                <div class="collapse-item py-2">
                    <div class="collapse-header flex justify-between items-center py-2 px-0 cursor-pointer group single-collapse-btn">
                        <span class="font-medium text-dark group-hover:text-primary transition-colors">步骤4：马帮ERP调拨记录批量作废（多页处理）</span>
                        <i class="fa fa-chevron-down text-xs text-gray group-hover:text-primary"></i>
                    </div>
                    <div class="collapse-content pl-2 text-gray">
                        <div class="step-card">
                            <p class="mb-2 font-medium text-dark/80">异常处理规则：</p>
                            <ul class="list-disc pl-6 space-y-1 mb-3 text-sm">
                                <li>单号搜索后若未检测到「搜索结果件数」元素，直接标记作废失败，回执单记录「未查询到任何作废记录」，继续下一个单号处理</li>
                                <li>按100条/页设置数据展示量，自动计算总页数（page_sum），逐页处理调拨记录，避免单页数据量过大导致操作卡顿</li>
                                <li>页码跳转时强制输入页码并点击跳转按钮，跳转后执行加载监控，确保页面数据完全刷新</li>
                                <li>全选操作前检测复选框状态，若已勾选则执行「取消+重新勾选」，解决作废后选中状态残留导致的漏选问题</li>
                                <li>点击批量作废后检测弹出框是否加载，未加载则标记失败，回执单记录「批量操作弹出框加载失败」，终止当前单号处理</li>
                                <li>强制校验「恢复原仓库库存」复选框为未勾选状态，若已勾选则自动取消，避免误操作导致库存异常</li>
                                <li>作废操作后检测「操作成功」弹窗，若存在则自动关闭，确保后续操作无弹窗遮挡</li>
                                <li>若作废后弹出框仍未关闭，标记为「数据作废出现异常」，回执单记录并关闭弹出框，避免影响后续流程</li>
                                <li>单个单号作废过程中出现任何异常，均捕获完整堆栈信息写入日志，回执单记录具体失败原因，不终止整个流程</li>
                                <li>无论作废成功/失败，最终都执行弹出框检测，若存在则强制关闭，确保流程清洁性</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 步骤5：回执单生成与保存 -->
                <div class="collapse-item py-2">
                    <div class="collapse-header flex justify-between items-center py-2 px-0 cursor-pointer group single-collapse-btn">
                        <span class="font-medium text-dark group-hover:text-primary transition-colors">步骤5：作废结果回执单生成与保存</span>
                        <i class="fa fa-chevron-down text-xs text-gray group-hover:text-primary"></i>
                    </div>
                    <div class="collapse-content pl-2 text-gray">
                        <div class="step-card">
                            <p class="mb-2 font-medium text-dark/80">异常处理规则：</p>
                            <ul class="list-disc pl-6 space-y-1 mb-3 text-sm">
                                <li>回执单数据通过pd.concat逐行追加，设置ignore_index=True重置索引，避免索引重复导致的Excel写入错误</li>
                                <li>所有作废结果均实时写入DataFrame，确保单个单号处理完成后立即记录，避免进程中断导致数据丢失</li>
                                <li>回执单保存时指定columns列顺序，确保Excel文件列名与预设一致（本次作废名单、批次作废件数、作废状态、失败原因）</li>
                                <li>回执单文件路径写入全局变量glv['RETURN_RECEIPT']，确保后续模块可直接调用，无需重复拼接路径</li>
                                <li>使用pandas的to_excel方法保存，设置index=False，避免生成多余的索引列，保证文件标准化</li>
                                <li>保存路径为共享存储的「处理完成」文件夹，确保文件可被相关人员访问，方便结果核查</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 步骤6：通用工具与页面监控 -->
                <div class="collapse-item py-2">
                    <div class="collapse-header flex justify-between items-center py-2 px-0 cursor-pointer group single-collapse-btn">
                        <span class="font-medium text-dark group-hover:text-primary transition-colors">步骤6：通用工具类与页面状态监控</span>
                        <i class="fa fa-chevron-down text-xs text-gray group-hover:text-primary"></i>
                    </div>
                    <div class="collapse-content pl-2 text-gray">
                        <div class="step-card">
                            <p class="mb-2 font-medium text-dark/80">异常处理规则：</p>
                            <ul class="list-disc pl-6 space-y-1 mb-3 text-sm">
                                <li>CommonUtil工具类禁止实例化（__new__抛出异常），仅提供静态方法，确保工具类的通用性和安全性</li>
                                <li>所有元素点击统一通过CommonUtil.click实现，点击前激活窗口，最多重试10次，每次间隔1s，提升点击成功率</li>
                                <li>点击操作内置merge_time合并延时（0.3s），避免连续点击导致页面响应异常，操作后固定等待1s获取反馈</li>
                                <li>支持ignore_error忽略错误模式，非核心操作可选择不抛出异常，保证流程整体连续性</li>
                                <li>10次重试失败则抛出「click timeout, element not exists」明确异常，记录目标元素标识（hc_/mb_前缀），方便定位</li>
                                <li>页面加载状态通过is_exists_loading函数监控，基于xbot_visual图像识别检测「加载中_图像」，最多循环300次</li>
                                <li>加载监控中每次检测间隔1s，未检测到加载图标后再等待1.5s，确保页面完全加载完成</li>
                                <li>加载超时则捕获完整堆栈信息写入日志，并抛出「加载失败」异常，终止当前操作</li>
                                <li>所有跨系统页面操作（点击、输入、跳转）后均强制执行加载状态监控，形成操作-等待的闭环，避免提前执行后续操作</li>
                                <li>输入操作使用simulative=False非模拟输入，确保特殊字符、长字符串能准确输入，避免模拟输入的兼容性问题</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 板块4：数据传输规范 -->
        <section class="bg-white rounded-xl p-6 shadow-card hover:shadow-card-hover transition-shadow duration-300">
            <div class="flex items-center mb-4">
                <div class="w-9 h-9 rounded-full bg-primary/10 flex items-center justify-center mr-3">
                    <i class="fa fa-exchange text-primary"></i>
                </div>
                <h2 class="text-xl sm:text-2xl font-semibold text-dark">四、数据传输规范</h2>
            </div>
            <div class="pl-12 space-y-3">
                <!-- 全部展开/收起按钮 - 绑定唯一ID，确保联动 -->
                <div class="collapse-header flex justify-between items-center py-3 px-4 bg-primaryLight/50 rounded-lg cursor-pointer transition-all duration-300 hover:bg-primaryLight/80" id="allCollapseBtn2">
                    <span class="font-medium text-primary">展开/收起所有数据传输规则</span>
                    <i class="fa fa-chevron-down text-xs text-primary"></i>
                </div>

                <!-- 规则1：海仓待作废单号提取规范 -->
                <div class="collapse-item py-2">
                    <div class="collapse-header flex justify-between items-center py-2 px-0 cursor-pointer group single-collapse-btn">
                        <span class="font-medium text-dark group-hover:text-primary transition-colors">规则1：海仓国际待作废单号提取规范</span>
                        <i class="fa fa-chevron-down text-xs text-gray group-hover:text-primary"></i>
                    </div>
                    <div class="collapse-content pl-2 text-gray">
                        <div class="step-card">
                            <ol class="list-decimal pl-6 space-y-1 text-sm">
                                <li>数据源页面：海仓国际系统「库存管理-入库订单」页面，固定操作路径不可切换</li>
                                <li>订单状态筛选：强制切换为「全部」状态，替代原「已完成」状态，适配业务需求变更</li>
                                <li>日期筛选条件：按全局变量glv['input_date_start']和glv['input_date_end']拼接为「开始~结束」格式，精准输入至日期输入框</li>
                                <li>数据量限制：单页最多展示90条数据，按实际数据件数计算循环次数（loop_count = 向上取整(数据件数/90)）</li>
                                <li>单号提取方式：通过线程爬取（thread_fetch_data）所有页面的备注单号，生成内存列表remark_list</li>
                                <li>数据校验：爬取完成后校验remark_list长度，为空则直接抛出异常，不参与后续作废流程</li>
                                <li>数据存储：提取的待作废单号以字符串列表形式存储，供马帮ERP作废模块直接调用</li>
                                <li>异常判定：搜索结果无数据、数据件数提取失败、爬取后无有效单号，均判定为数据异常，终止流程</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- 规则2：马帮调拨记录作废筛选规范 -->
                <div class="collapse-item py-2">
                    <div class="collapse-header flex justify-between items-center py-2 px-0 cursor-pointer group single-collapse-btn">
                        <span class="font-medium text-dark group-hover:text-primary transition-colors">规则2：马帮ERP调拨记录作废筛选规范</span>
                        <i class="fa fa-chevron-down text-xs text-gray group-hover:text-primary"></i>
                    </div>
                    <div class="collapse-content pl-2 text-gray">
                        <div class="step-card">
                            <ol class="list-decimal pl-6 space-y-1 text-sm">
                                <li>固定访问页面：马帮ERP「仓库-分仓调拨-仓库调拨发货」页面，不可切换至其他调拨相关页面</li>
                                <li>通用筛选条件：所有作废操作均需勾选「待签收」状态，仅作废未签收的调拨记录，确保业务合规</li>
                                <li>单号匹配方式：通过「备注」搜索框输入待作废单号，实现单号与调拨记录的模糊匹配</li>
                                <li>数据展示设置：作废前强制将单页展示量设置为100条，提升多页数据处理效率</li>
                                <li>多页处理规则：按实际搜索结果件数计算总页数（page_sum = 向上取整(数据件数/100)），逐页跳转处理</li>
                                <li>页码跳转方式：在页码输入框手动输入目标页码，点击跳转按钮，禁止使用翻页按钮，确保跳转准确性</li>
                                <li>数据校验：单号搜索后未检测到「搜索结果件数」元素，判定为无匹配记录，标记作废失败</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- 规则3：马帮批量作废操作规范 -->
                <div class="collapse-item py-2">
                    <div class="collapse-header flex justify-between items-center py-2 px-0 cursor-pointer group single-collapse-btn">
                        <span class="font-medium text-dark group-hover:text-primary transition-colors">规则3：马帮ERP调拨记录批量作废操作规范</span>
                        <i class="fa fa-chevron-down text-xs text-gray group-hover:text-primary"></i>
                    </div>
                    <div class="collapse-content pl-2 text-gray">
                        <div class="step-card">
                            <ol class="list-decimal pl-6 space-y-1 text-sm">
                                <li>全选操作规则：检测批次编号全选框状态，已勾选则执行「取消+重新勾选」，未勾选则直接勾选，解决选中状态残留问题</li>
                                <li>批量操作路径：点击「批量操作按钮」→选择「批量作废」，固定操作路径不可变更</li>
                                <li>关键复选框控制：「恢复原仓库库存」复选框强制保持未勾选状态，若已勾选则自动取消，避免库存异常</li>
                                <li>确认操作规则：点击弹出框「确认按钮」执行作废，操作后必须执行加载状态监控，确保作废操作完成</li>
                                <li>成功判定标准：作废后出现「操作成功」弹窗并可正常关闭，判定为单页作废成功</li>
                                <li>失败判定标准：弹出框加载失败、操作后弹出框未关闭、未查询到匹配记录，均判定为作废失败</li>
                                <li>异常兜底：无论作废成功/失败，最终均检测并关闭批量作废弹出框，确保流程清洁</li>
                                <li>多页处理逻辑：单页作废完成后跳转至下一页，重复全选-作废流程，直至所有页面处理完毕</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- 规则4：作废回执单生成规范 -->
                <div class="collapse-item py-2">
                    <div class="collapse-header flex justify-between items-center py-2 px-0 cursor-pointer group single-collapse-btn">
                        <span class="font-medium text-dark group-hover:text-primary transition-colors">规则4：作废结果回执单生成规范</span>
                        <i class="fa fa-chevron-down text-xs text-gray group-hover:text-primary"></i>
                    </div>
                    <div class="collapse-content pl-2 text-gray">
                        <div class="step-card">
                            <ol class="list-decimal pl-6 space-y-1 text-sm">
                                <li>文件格式：固定为XLSX格式，兼容WPS/Excel所有版本，支持在线预览与本地编辑</li>
                                <li>表头规范：固定为「本次作废名单、批次作废件数、作废状态、失败原因」四列，不可新增/删除/修改列名与顺序</li>
                                <li>数据类型：所有列均为字符串类型，避免数字类型导致的显示异常</li>
                                <li>数据填充规则：单个单号处理完成后立即填充，成功则记录件数与成功状态，失败则记录具体失败原因</li>
                                <li>批次作废件数：按马帮ERP搜索结果的实际数据件数记录，确保数据准确性</li>
                                <li>作废状态：仅包含「成功」「失败」两种状态，无其他自定义状态，确保标准化</li>
                                <li>失败原因：精准记录具体失败场景，如「未查询到任何作废记录」「批量操作弹出框加载失败」等，方便问题定位</li>
                                <li>索引设置：保存时设置index=False，不生成多余索引列，保证文件整洁性</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- 规则5：文件命名与存储规范 -->
                <div class="collapse-item py-2">
                    <div class="collapse-header flex justify-between items-center py-2 px-0 cursor-pointer group single-collapse-btn">
                        <span class="font-medium text-dark group-hover:text-primary transition-colors">规则5：输出文件命名与存储规范</span>
                        <i class="fa fa-chevron-down text-xs text-gray group-hover:text-primary"></i>
                    </div>
                    <div class="collapse-content pl-2 text-gray">
                        <div class="step-card">
                            <ol class="list-decimal pl-6 space-y-1 text-sm">
                                <li>存储路径：glv['Output_Folder']/处理完成，自动创建「处理完成」文件夹，所有回执单统一归档</li>
                                <li>文件命名规则：分仓调拨记录作废_回执单_{当前时间戳}.xlsx，如分仓调拨记录作废_回执单_20260129153000.xlsx</li>
                                <li>命名唯一性：通过当前时间戳确保文件名唯一，避免重复执行时文件覆盖</li>
                                <li>路径存储：回执单绝对路径写入全局变量glv['RETURN_RECEIPT']，供后续模块调用</li>
                                <li>文件权限：生成文件继承文件夹权限，确保供应链/计划部相关人员可正常读取、下载、编辑</li>
                                <li>归档要求：生成的回执单无需手动移动，直接存储在「处理完成」文件夹，方便后续核查与归档</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- 规则6：全局变量数据传输规范 -->
                <div class="collapse-item py-2">
                    <div class="collapse-header flex justify-between items-center py-2 px-0 cursor-pointer group single-collapse-btn">
                        <span class="font-medium text-dark group-hover:text-primary transition-colors">规则6：全局变量数据传输规范</span>
                        <i class="fa fa-chevron-down text-xs text-gray group-hover:text-primary"></i>
                    </div>
                    <div class="collapse-content pl-2 text-gray">
                        <div class="step-card">
                            <ol class="list-decimal pl-6 space-y-1 text-sm">
                                <li>核心入参：glv['Output_Folder']（输出根路径）、glv['retry_times']（重试次数）、glv['dict_login_info']（跨系统登录信息）、glv['Site']（站点类型：泰国/菲律宾）、glv['input_date_start/input_date_end']（日期筛选范围），由外部配置传入</li>
                                <li>登录信息格式：dict_login_info按系统分类，包含「海仓泰国/海仓菲律宾/马帮ERP」，每个系统含[登录地址,账号,密码,用户名]四个元素</li>
                                <li>输出变量：glv['RETURN_RECEIPT']（作废回执单绝对路径），流程内生成后写入，供后续模块调用</li>
                                <li>元素标识前缀：海仓国际元素统一为hc_（element_8d9ca3fe>）、马帮ERP元素统一为mb_（element_e75ea9c3>），确保元素定位准确</li>
                                <li>变量类型：所有路径类变量为绝对路径，避免相对路径导致的文件找不到问题；次数类变量为整数，确保重试逻辑准确</li>
                                <li>站点区分：通过glv['Site']自动加载对应站点的海仓国际登录信息，无需手动切换，实现多站点适配</li>
                                <li>变量生命周期：全局变量贯穿整个流程，流程结束后不自动销毁，可用于问题排查与日志分析</li>
                                <li>配置要求：所有入参需在流程启动前配置完成，确保流程无人工干预自动执行</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 板块5：系统依赖 -->
        <section class="bg-white rounded-xl p-6 shadow-card hover:shadow-card-hover transition-shadow duration-300">
            <div class="flex items-center mb-4">
                <div class="w-9 h-9 rounded-full bg-primary/10 flex items-center justify-center mr-3">
                    <i class="fa fa-cogs text-primary"></i>
                </div>
                <h2 class="text-xl sm:text-2xl font-semibold text-dark">五、系统依赖</h2>
            </div>
            <div class="pl-12 space-y-4">
                <!-- 环境依赖 -->
                <div class="bg-primaryLight/30 rounded-lg p-4">
                    <h3 class="font-medium text-primary mb-2">5.1 运行环境依赖</h3>
                    <ul class="list-disc pl-6 text-sm space-y-1">
                        <li>操作系统：Windows 10/11 64位（需支持taskkill、os.system系统命令，用于进程清理）</li>
                        <li>浏览器：Google Chrome 90.0+（支持最大化启动、窗口激活、元素定位、非模拟输入、多窗口管理）</li>
                        <li>办公软件：WPS Office 2021+/Microsoft Excel 2016+（支持xlsx格式、无锁文件读写、在线预览）</li>
                        <li>运行时：Python 3.8+（需安装指定第三方库，支持pandas数据处理、xbot自动化操作）</li>
                        <li>自动化框架：xbot/xbot_visual（影刀RPA框架，提供网页自动化、图像识别、窗口管理核心能力）</li>
                        <li>存储服务：网络共享存储/本地磁盘（支持Excel文件写入、路径配置、多用户访问）</li>
                        <li>网络环境：稳定的网络连接，可正常访问海仓国际系统与马帮ERP官网，无代理限制，支持多页面同时加载</li>
                    </ul>
                </div>
                <!-- Python库依赖 -->
                <div class="bg-primaryLight/30 rounded-lg p-4">
                    <h3 class="font-medium text-primary mb-2">5.2 Python第三方库依赖</h3>
                    <ul class="list-disc pl-6 text-sm space-y-1">
                        <li>网页自动化：xbot、xbot_visual（影刀核心库，提供网页操作、图像识别、窗口管理、文件操作能力）</li>
                        <li>Excel操作：pandas（回执单DataFrame初始化、数据追加、Excel文件保存）</li>
                        <li>数据处理：re（内置，正则表达式提取数据件数）、math（内置，向上取整计算循环次数）</li>
                        <li>时间处理：datetime（内置，日期计算、格式转换）、time（内置，延时、等待、时间戳生成）</li>
                        <li>文件操作：os（内置，路径处理、文件夹创建、进程调用）</li>
                        <li>日志与异常：xbot.app.logging（系统日志记录）、traceback（内置，异常堆栈信息捕获）</li>
                        <li>窗口操作：xbot.win32（内置，发送键盘指令、窗口激活）</li>
                    </ul>
                </div>
                <!-- 权限依赖 -->
                <div class="bg-primaryLight/30 rounded-lg p-4">
                    <h3 class="font-medium text-primary mb-2">5.3 权限依赖</h3>
                    <ul class="list-disc pl-6 text-sm space-y-1">
                        <li>海仓国际系统：按站点（泰国/菲律宾）拥有「库存管理-入库订单」的<b>查看/筛选/搜索/多页浏览</b>权限，可查看入库订单备注信息</li>
                        <li>马帮ERP：拥有「仓库-分仓调拨-调拨发货」的<b>查看/筛选/搜索/批量作废/全选</b>权限，可操作待签收状态的调拨记录</li>
                        <li>存储服务：输出根路径（glv['Output_Folder']）的<b>读/写/新建/删除</b>权限，可自动创建「处理完成」文件夹并写入Excel文件</li>
                        <li>系统权限：允许执行taskkill命令（终止WPS残留进程）、允许os.system调用系统命令、允许创建多线程爬取数据</li>
                        <li>浏览器权限：允许Chrome浏览器最大化启动、允许同时打开多个窗口、允许非模拟输入、允许关闭所有窗口</li>
                        <li>账号权限：海仓国际（泰国/菲律宾）与马帮ERP的账号均拥有正常的登录/退出权限，无登录限制与操作时长限制</li>
                        <li>文件权限：允许读取/写入XLSX格式文件，无文件加密/保护限制，生成的回执单可被多用户访问</li>
                    </ul>
                </div>
                <!-- 配置文件依赖 -->
                <div class="bg-primaryLight/30 rounded-lg p-4">
                    <h3 class="font-medium text-primary mb-2">5.4 配置文件与模块依赖</h3>
                    <ul class="list-disc pl-6 text-sm space-y-1">
                        <li>全局变量：glv（package.variables），核心参数：Output_Folder、retry_times、dict_login_info、Site、input_date_start、input_date_end、RETURN_RECEIPT</li>
                        <li>自定义工具模块：tools.py（提供get_time/get_past_date等时间处理方法，生成时间戳与日期）</li>
                        <li>扩展模块：mb_close_box.py（xbot_extensions，马帮ERP登录后弹窗关闭专用模块）</li>
                        <li>自定义业务类：Seacang（海仓国际单号提取业务封装）、Maban（马帮ERP批量作废业务封装），封装核心业务逻辑</li>
                        <li>通用工具类：CommonUtil（静态类，封装通用点击方法，提供重试/激活/容错能力，禁止实例化）</li>
                        <li>图像资源：「加载中_图像」（xbot_visual图像识别用，需与海仓国际、马帮ERP实际加载图标一致）</li>
                        <li>元素标识：hc_（海仓国际元素前缀）、mb_（马帮ERP元素前缀），所有页面元素标识固定，确保定位准确</li>
                        <li>第三方扩展：xbot_extensions.activity_9516e750（提供海仓/马帮专属扩展能力）</li>
                    </ul>
                </div>
            </div>
        </section>
    </main>

    <!-- 折叠面板交互逻辑 - 修复所有问题：绑定所有点击事件、图标旋转、全部联动 -->
    <script>
        // 页面加载完成后初始化所有交互，确保DOM元素已完全加载
        document.addEventListener('DOMContentLoaded', function() {
            // 通用方法：切换单个面板状态（含active类切换、图标旋转）
            const toggleSingleCollapse = (btn) => {
                btn.classList.toggle('active');
                const icon = btn.querySelector('i.fa-chevron-down');
                if (icon) {
                    icon.style.transform = btn.classList.contains('active') ? 'rotate(180deg)' : 'rotate(0)';
                }
            };

            // 通用方法：切换全部面板状态（联动单个面板+自身图标旋转）
            const toggleAllCollapse = (allBtn, sectionSelector) => {
                allBtn.classList.toggle('active');
                const isActive = allBtn.classList.contains('active');
                // 联动当前板块下所有单个折叠面板
                const singleBtns = allBtn.closest(sectionSelector).querySelectorAll('.single-collapse-btn');
                singleBtns.forEach(btn => {
                    if (isActive) {
                        btn.classList.add('active');
                        btn.querySelector('i.fa-chevron-down').style.transform = 'rotate(180deg)';
                    } else {
                        btn.classList.remove('active');
                        btn.querySelector('i.fa-chevron-down').style.transform = 'rotate(0)';
                    }
                });
                // 自身图标旋转同步
                const allIcon = allBtn.querySelector('i.fa-chevron-down');
                allIcon.style.transform = isActive ? 'rotate(180deg)' : 'rotate(0)';
            };

            // 1. 绑定所有单个折叠面板的点击事件（解决点不开问题）
            const allSingleBtns = document.querySelectorAll('.single-collapse-btn');
            allSingleBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    toggleSingleCollapse(this);
                });
            });

            // 2. 绑定异常处理机制板块「全部展开/收起」按钮（联动单个面板）
            const allCollapseBtn = document.getElementById('allCollapseBtn');
            if (allCollapseBtn) {
                allCollapseBtn.addEventListener('click', function() {
                    toggleAllCollapse(this, 'section:nth-child(3)');
                });
            }

            // 3. 绑定数据传输规范板块「全部展开/收起」按钮（联动单个面板）
            const allCollapseBtn2 = document.getElementById('allCollapseBtn2');
            if (allCollapseBtn2) {
                allCollapseBtn2.addEventListener('click', function() {
                    toggleAllCollapse(this, 'section:nth-child(4)');
                });
            }

            // 初始化：确保所有折叠图标初始状态为未旋转，无默认active类
            document.querySelectorAll('.collapse-header i.fa-chevron-down').forEach(icon => {
                icon.style.transform = 'rotate(0)';
            });
            document.querySelectorAll('.collapse-header').forEach(btn => {
                btn.classList.remove('active');
            });
        });
    </script>
</body>
</html>
